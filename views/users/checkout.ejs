<%- include('../userLayout/header.ejs')%>

    <%- include('../userLayout/head.ejs') %>

    <div id="reloadDiv">
        <main class="main">
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/SHOP">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
                <div class="checkout">
                    <div class="container">
                        <div class="checkout-discount">
                          <div class="checkout-discount">
            				
        						
							
                            <a   data-bs-toggle="modal" class="btn btn-primary" data-bs-target="#addCouponModal">View Avilable Coupons</a>
              
                           <!-- Modal -->
                <div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">COUPONS</h5>
                        
                      </div>
                      <div class="modal-body">
                          
                             <% if(coupons .length > 0){
                      coupons.forEach((coupon) => { %>
              
                      
                    
                    <div class="container my-5" >
                      <div class="d-flex coulmn">
                        <div class="col-lg-6">
                          <div class="coupon bg-white">
                            <div class="row no-gutters">
                              <div class="col-lg-4 border-right d-flex flex-column justify-content-center">
                                <div class="d-flex flex-column align-items-center ">
                                  <img src="/userAssets/images/brands/2.png" style="width: 50px;">
                                  <!-- <span class="d-block">PH TIMES</span> -->
                                  <!-- <span class="text-black-50">Shoes</span> -->
                                </div>
                              </div>
                              <div class="col-lg-8">
                                <div>
                                  <div class="d-flex flex-row justify-content-end off">
                                    <h2><%= coupon.discountPercentage %>%</h2>
                                    <span>OFF</span>
                                  </div>
                                  <div class="d-flex flex-row justify-content-between off px-3 p-2">
                                    <span>Promo code:</span>
                                    <a onclick="copyCode('<%= coupon.code %>')"><span class="border border-success px-3 rounded code"><%= coupon.code %> | COPY</span></a>
                                  </div>
                                  <div class="d-flex flex-row justify-content-between off px-3 p-2">
                                    <span>Purchase Above</span>
                                    <span class=" px-3"><%= coupon.criteria %> Rupees</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
              
              
                    <% })
                    } %>
              
                              <button type="button" class="btn btn-dark  m-5	" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                      </div> 
                    </div>
                  </div>
                </div>
              </div><!-- End .checkout-discount -->
              
                                <div class="checkout-discount">
                                  <form action="" >
                                  <input type="text" class="form-control" placeholder="Click here to enter your code" required id="code">
                                  <a onclick="applycoupon($('#code').val())" type="Submit" class="btn btn-outline-danger">APPLY COUPON</a>
                            </form>
                             </div>
                        </div><!-- End .checkout-discount -->
                        <form action="#" id="checkout-form" >
                            <div class="row">
                                <div class="col-lg-9">
                                    <h2 class="checkout-title">Billing Details</h2><!-- End .checkout-title -->
                                    <div class="row">
                                        <div class="col-lg-12">
                                          <div class="d-flex justify-content-end pb-2">
                                            <a href="/insertAddress" type="button" class="btn btn-outline-primary-2"> Add
                                                Address</a>
                                        </div>
                                            <% if(address.length> 0){
                                                address.forEach((address)=>{
                                                %>
                                                <div class="card card-dashboard">
                                                    <div class="card-body">
                                                      <input class="form-check-input pt-5" required type="radio" name="selectAddress" id="flexRadioDefault1"
                                                      value="<%=address.userName %>,<%=address.mobile %>,<%=address.altrenativeMob %>,<%=address.houseName %>,<%=address.city %>,<%=address.state %>,<%=address.pincode %>,<%=address.landmark %>">
                                                       
                                                        <ul>
                                                          <h3 class="card-title"> Address</h3><!-- End .card-title -->
                                                            <li>Name : <%=address.userName %>
                                                            </li>
                                                            <li>mobile : <%=address.mobile %>
                                                            </li>
                                                            <li>altrenativeMob : <%=address.altrenativeMob %>
                                                            </li>
                                                            <li>houseName : <%=address.houseName %>
                                                            </li>
                                                            <li>city : <%=address.city %>
                                                            </li>
                                                            <li>state : <%=address.state %>
                                                            </li>
                                                            <li>pincode : <%=address.pincode %>
                                                            </li>
                                                            <li>landmark : <%=address.landmark %>
                                                            </li>
                                                            <a href="/editAddress/?id=<%= address._id %>">
                                                                <button type="button" class="btn btn-outline-primary-2">
                                                                    Edit
                                                                </button>
                                                            </a>
                                                            <a href="">
                                                                
                                                                    <a class="btn btn-outline-primary-2" type="button"
                                                                            onclick="deleteAddress('<%= address._id%>')">Delete</a>
                                                                </button>
                                                            </a>

                                                        </ul>
                                                </div><!-- End .card-dashboard -->
                                        </div>
                                        <% }) }else{ %>
                                          <div class="col-lg-12">
                                            <div >
                                                <h3 class="text-center mt-5" > [Add a Address]</h3>
                                            </div>
                                          
                                    </div><!-- End .col-lg-12 -->
                                    <%}%>   
                                    </div><!-- End .col-lg-12 -->
                                </div><!-- End .row -->
                            </div><!-- End .col-lg-9 -->
                            <aside class="col-lg-3">
                                <div class="summary">
                                    <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->
                                    <table class="table table-summary">
                                        <tbody>
                                          
                                            <tr class="summary-subtotal">
                                                <td>Wallet:</td>
                                                <td>₹<%=user.wallet%>.00</td>
                                            </tr><!-- End .summary-subtotal -->
                                            <tr class="summary-subtotal">
                                                <td>Subtotal:</td>
                                                <td>₹<%=Total%>.00</td>
                                            </tr><!-- End .summary-subtotal -->
                                            <tr>
                                                <td>Shipping:</td>
                                                <td>₹ 0.00</td>
                                            </tr>
                                            <tr>
                                              <td >Discount:</td>
                                              <td>₹ <span id="discount">.00</span></td>
                                            </tr>
                                            <tr class="summary-total">
                                                <td>Total:</td>
                                                <td>₹<span id="total"><%= totalAmount %></span></td>
                                            </tr><!-- End .summary-total -->
                                        </tbody>
                                    </table><!-- End .table table-summary -->
                                   
                                        <div class="accordion-summary"> 
                                           <div class="d-flex align-items-center">
                                                <div class="mr-2">
                                                  <input required type="radio" id="walletpayement" name="payment" value="walletpayement">
                                                </div>
                                                <a href="" class="d-block text-dark">Wallet Payement</a>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div class="mr-2">
                                                    <input required type="radio" id="COD" name="payment" value="COD">
                                                </div>
                                                <a href="" class="d-block text-dark" for="pay1">Cash On Delivery</a>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div class="mr-2">
                                                  <input required type="radio" id="onlinPayment" name="payment" value="onlinPayment">
                                                </div>
                                                <a href="" class="d-block text-dark">Razer Pay</a>
                                            </div>
                                           
                                          </div><!-- End .accordion -->

                                   
                                          <%if(address.length>0){%>
                                    <button type="submit" class="btn btn-outline-primary-2 btn-order btn-block">
                                        <span class="btn-text">Place Order</span>
                                        <span class="btn-hover-text">Place Order</span>
                                    </button>
                                    <%}else{%>
                                      <button onclick="addAddress()" class="btn btn-outline-primary-2 btn-order btn-block">
                                        <span class="btn-text">Place Order</span>
                                        <span class="btn-hover-text">Place Order</span>
                                      <%}%>
                                    </a>
                                </div><!-- End .summary -->
                            </aside><!-- End .col-lg-3 -->
                    </div><!-- End .row -->
                    </form>
                </div><!-- End .container -->
            </div><!-- End .checkout -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->
        </div>

        <script>

$("#checkout-form").submit((e) => {
        let address = $("input[name=selectAddress]:checked").val();    
        let total = document.getElementById("total").innerHTML;
        let payment =  $("input[name=payment]:checked").val();
        e.preventDefault();
        $.ajax({
          url: "/checkout",
          method: "post",
          data: {
            Total: total,
            address: address,
            payment : payment 
          },
          success: (response) => {
            if (response.codsuccess == true) {
              swal.fire({
                positon: 'center',
                icon: "success",
                title: 'Order Placed Successfully',
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: "Go to Shop",
              }).then((result) => {
                if (result.dismiss === swal.DismissReason.cancel) {
                  // Redirect to the shop page
                  window.location.href = "/shop";
                }
              });
            }else if(response.walletFailed == true){
              swal.fire({
                  positon: 'center',
                  icon: "error",
                  title: 'Insufficient Balance In Your Wallet',
                  showConfirmButton: false,
                  showCancelButton: false,
                  timer:1500
              })
		      }
            else{
              razorPayment(response.order)
            }
          }
        });
      });


      
      function razorPayment(order){
       
  var options = {
    "key": "rzp_test_G6jLujfVN1hG00", // Enter the Key ID generated from the Dashboard
    "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Acme Corp", //your business name
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function(response) {
       verifyPayment(response, order);
    },
    "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information especially their phone number
        "name": "Gaurav Kumar", //your customer's name
        "email": "gaurav.kumar@example.com",
        "contact": "9000090000" //Provide the customer's phone number for better conversion rates 
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);
    rzp1.open();
}



function verifyPayment(payment,order){
    const amount2 = document.getElementById("total").innerHTML;
    $.ajax({
      url:"/verifyPayment",
      method:"post",
      data:{
        payment: payment,
        amount2: amount2,
        order: order
      },
      success:(response)=>{
        if(response.success){
          swal.fire({
            positon: 'center',
            icon: "success",
            title: 'Order Placed Successfully',
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: "Go to Shop",
        }).then((result) => {
            if (result.dismiss === swal.DismissReason.cancel) {
              window.location.href = "/shop";
            }
          });
        }else{
          swal.fire({
            positon: 'center',
            icon: "error",
            title: 'payment failed',
            showConfirmButton: false,
            timer:1500,
        })
        }
      }
    })
  }




            function deleteAddress(id) {
              Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!",
                cancelButtonText: "Cancel",
              }).then((result) => {
                if (result.isConfirmed) {
                  $.ajax({
                    url: "/deleteAddress",
                    data: {
        
                      id: id,
                    },
                    method: "post",
                    success: (response) => {
                      if ((response.remove = true)) {
                        location.reload();
                      }
                    },
                  });
                }
              });
            }

            function addAddress(){
          swal.fire({
            positon: 'center',
            icon: "error",
            title: 'please add address',
            showConfirmButton: false,
            timer:1500,
        })
        }

        // COPY COUPON CODE

function copyCode(code) {
          navigator.clipboard.writeText(code)
          .then(function() {
             alert('Coupon code copied to clipboard!');
          })
         .catch(function() {
             alert('Failed to copy coupon code.');
      });
      }

      // COUPON APPLY
      function applycoupon(code){
    event.preventDefault();
    const amount = document.getElementById('total').innerHTML;
    $.ajax({
      method:'post',
      url:'/applyCoupon',
      data:{
        amount:amount,
        code:code,
      },success:(response)=>{
        if(response.user){
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'This coupon already used!'
          })
        }else if(response.date){
          console.log("coupon date expired");
          Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'date expired!!!'
              })
        }else if(response.amountOkey){
          document.getElementById('discount').innerHTML = response.disAmount
          document.getElementById('total').innerHTML = response.disTotal
          Swal.fire({
            position: 'center',
            icon: 'success',
            title: 'Discount redeemed',
            showConfirmButton: false,
            timer: 1500
          })
        }else if(response.invalid){
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Invalid Coupon!!!'
          })
        }
      }
    });
  }


          </script>

        
    <%- include('../userLayout/footer.ejs') %>